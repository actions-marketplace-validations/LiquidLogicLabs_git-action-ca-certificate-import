name: Test

on:
  workflow_call:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-22.04
    name: Test Certificate Action
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Test 1: Local file installation
      - name: Create test certificate
        run: |
          mkdir -p test-certs
          openssl req -x509 -newkey rsa:2048 -keyout test-certs/test-key.pem \
            -out test-certs/test-ca.crt -days 365 -nodes \
            -subj "/C=US/ST=Test/L=Test/O=Test/CN=test.example.com"
      
      - name: Test - Local file installation
        uses: ./
        with:
          certificate-source: 'test-certs/test-ca.crt'
          debug: 'true'
      
      - name: Verify local file installation
        run: |
          if [ -f /usr/local/share/ca-certificates/custom-ca-*.crt ]; then
            echo "✓ Certificate installed from local file"
          else
            echo "✗ Certificate not found in system CA store"
            exit 1
          fi
      
      # Test 2: BuildKit generation
      - name: Test - BuildKit generation
        id: buildkit-test
        uses: ./
        with:
          certificate-source: 'test-certs/test-ca.crt'
          certificate-name: 'buildkit-test.crt'
          generate-buildkit: 'true'
          debug: 'true'
      
      - name: Verify BuildKit generation
        run: |
          BUILDKIT_PATH="${{ steps.buildkit-test.outputs.buildkit-path }}"
          if [ -f "$BUILDKIT_PATH" ]; then
            echo "✓ buildkit.toml generated successfully"
            echo "  Path: $BUILDKIT_PATH"
            
            # Verify buildkit.toml content and structure
            if grep -q "buildkit-test.crt" "$BUILDKIT_PATH" && grep -q "\[worker.oci\]" "$BUILDKIT_PATH"; then
              echo "✓ buildkit.toml has correct content and structure"
            else
              echo "✗ buildkit.toml missing required content or structure"
              exit 1
            fi
            
            # Verify no runtime configuration (default behavior)
            if grep -q "\[worker.containerd\]" "$BUILDKIT_PATH"; then
              echo "✗ buildkit.toml should not contain runtime configuration by default"
              exit 1
            else
              echo "✓ buildkit.toml correctly omits runtime configuration by default"
            fi
          else
            echo "✗ buildkit.toml not generated"
            exit 1
          fi
      
      # Test 3: BuildKit generation with custom runtime
      - name: Test - BuildKit generation with runtime
        id: buildkit-runtime-test
        uses: ./
        with:
          certificate-source: 'test-certs/test-ca.crt'
          certificate-name: 'buildkit-runtime-test.crt'
          generate-buildkit: 'true'
          buildkit-runtime: 'io.containerd.runc.v2'
          debug: 'true'
      
      - name: Verify BuildKit generation with runtime
        run: |
          BUILDKIT_PATH="${{ steps.buildkit-runtime-test.outputs.buildkit-path }}"
          if [ -f "$BUILDKIT_PATH" ]; then
            echo "✓ buildkit.toml generated successfully with runtime config"
            echo "  Path: $BUILDKIT_PATH"
            
            # Verify buildkit.toml content and structure
            if grep -q "buildkit-runtime-test.crt" "$BUILDKIT_PATH" && grep -q "\[worker.oci\]" "$BUILDKIT_PATH"; then
              echo "✓ buildkit.toml has correct content and structure"
            else
              echo "✗ buildkit.toml missing required content or structure"
              exit 1
            fi
            
            # Verify runtime configuration is present
            if grep -q "\[worker.containerd\]" "$BUILDKIT_PATH" && grep -q "io.containerd.runc.v2" "$BUILDKIT_PATH"; then
              echo "✓ buildkit.toml correctly includes runtime configuration"
            else
              echo "✗ buildkit.toml missing runtime configuration"
              exit 1
            fi
          else
            echo "✗ buildkit.toml not generated"
            exit 1
          fi
      
      - name: Test Summary
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ All tests passed successfully!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

